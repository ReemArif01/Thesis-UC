---
title: "test"
output: html_document
---

```{r}
install.packages("tidyverse")
install.packages("dplyr")
```

```{r}
library(tidyverse)
library(dplyr)
library(rvest)
library(tibble)
library(stringr)

install.packages(c("httr2", "jsonlite", "dplyr", "purrr", "stringr", "readr"))
library(httr2)
library(jsonlite)
library(dplyr)
library(purrr)
library(readr)

```

```{r}
#This where you find the list of UN decisions
##https://main.un.org/securitycouncil/en/sanctions/1267/press-releases?page=0

```

```{r}

install.packages(c("jsonlite"))
library(jsonlite)

`%||%` <- function(x, y) if (is.null(x)) y else x

folder <- "/Users/reemarif/Desktop/1st Quarter/MA Sources/Thesis-UC"
path <- file.path(folder, "entities.ftm (1).json")

con <- file(path, open = "r")

rows <- list()
i <- 0
k <- 0

while (length(line <- readLines(con, n = 1, warn = FALSE)) > 0) {
  i <- i + 1
  x <- fromJSON(line, simplifyVector = FALSE)

  # keep only EU FSF organizations
  if (identical(x$schema, "Organization") && ("eu_fsf" %in% (x$properties$datasets %||% character()))) {
    k <- k + 1
    rows[[k]] <- tibble(
      id = x$id %||% NA_character_,
      name = x$caption %||% NA_character_,
      first_seen = x$properties$first_seen %||% NA_character_,
      last_seen  = x$properties$last_seen  %||% NA_character_
    )
  }

  if (i %% 5000 == 0) message("Read ", i, " lines; kept ", k, " EU FSF orgs")
}

close(con)

df <- bind_rows(rows)
write.csv(df, file.path(folder, "eu_fsf_organizations.csv"), row.names = FALSE)

test_orgs <- keep(entities, ~ .x$schema == "Organization")
length(test_orgs)
unique(unlist(map(test_orgs[1:100], ~ .x$datasets %||% character())))
```
```{r}
ath <- "/Users/reemarif/Desktop/1st Quarter/MA Sources/Thesis-UC/entities.ftm (1).json"
con <- file(path, open = "r")

n <- 0
n_org <- 0

while (length(line <- readLines(con, n = 1, warn = FALSE)) > 0 && n < 20000) {
  n <- n + 1
  x <- fromJSON(line, simplifyVector = FALSE)
  if (identical(x$schema, "Organization")) n_org <- n_org + 1
}

close(con)
c(total_checked = n, organizations = n_org)
```
```{r}

`%||%` <- function(x, y) if (is.null(x)) y else x

path <- "/Users/reemarif/Desktop/1st Quarter/MA Sources/Thesis-UC/entities.ftm (1).json"
con <- file(path, open = "r")

vals <- character()
n <- 0

while (length(line <- readLines(con, n = 1, warn = FALSE)) > 0 && n < 30000) {
  n <- n + 1
  x <- fromJSON(line, simplifyVector = FALSE)

  if (identical(x$schema, "Organization")) {
    ds <- (x$datasets %||% x$properties$datasets %||% character())

    # force to a plain character vector
    ds <- unlist(ds, use.names = FALSE)

    if (length(ds) > 0) vals <- c(vals, ds)
  }
}

close(con)

vals <- unlist(vals, use.names = FALSE)

# Now these will work
head(sort(unique(vals)), 50)
"eu_fsf" %in% vals

# Top 30 most common dataset tags
sort(table(vals), decreasing = TRUE)[1:30]


```

```{r}

`%||%` <- function(x, y) if (is.null(x)) y else x

path <- "/Users/reemarif/Desktop/1st Quarter/MA Sources/Thesis-UC/entities.ftm (1).json"
con <- file(path, open = "r")

rows <- list()
i <- 0
k <- 0

while (length(line <- readLines(con, n = 1, warn = FALSE)) > 0) {
  i <- i + 1
  x <- fromJSON(line, simplifyVector = FALSE)

  if (identical(x$schema, "Organization")) {
    ds <- unlist(x$datasets %||% x$properties$datasets %||% character(), use.names = FALSE)

    if ("eu_fsf" %in% ds) {
      k <- k + 1
      rows[[k]] <- tibble(
        id = x$id %||% NA_character_,
        name = x$caption %||% NA_character_,
        datasets = paste(ds, collapse = "; ")
      )
    }
  }

  if (i %% 10000 == 0) message("Read ", i, " lines; kept ", k, " EU FSF orgs")
}

close(con)

df <- bind_rows(rows)
nrow(df)
head(df, 20)

write.csv(df, "/Users/reemarif/Desktop/eu_fsf_organizations.csv", row.names = FALSE)

```
```{r}
# pick one EU FSF org id
one_id <- df$id[1]

# re-read just that one entity from the big file (simple but works)
con <- file(path, open = "r")
found <- NULL
while (length(line <- readLines(con, n = 1, warn = FALSE)) > 0) {
  x <- fromJSON(line, simplifyVector = FALSE)
  if (!is.null(x$id) && identical(x$id, one_id)) { found <- x; break }
}
close(con)

names(found$properties)
str(found$properties, max.level = 2)

```
```{r}
`%||%` <- function(x, y) if (is.null(x)) y else x

path <- "/Users/reemarif/Desktop/1st Quarter/MA Sources/Thesis-UC/entities.ftm (1).json"

con <- file(path, open = "r")
on.exit(close(con), add = TRUE)

rows <- list()
i <- 0
k <- 0

while (length(line <- readLines(con, n = 1, warn = FALSE)) > 0) {
  i <- i + 1
  x <- fromJSON(line, simplifyVector = FALSE)

  if (identical(x$schema, "Organization")) {
    ds <- unlist(x$datasets %||% x$properties$datasets %||% character(), use.names = FALSE)

    pid <- unlist(x$properties$programId %||% character(), use.names = FALSE)

    # TEMP diagnostic: keep anything that mentions terrorism
    if (any(str_detect(tolower(pid), "terror|931"))) {
      k <- k + 1
      rows[[k]] <- tibble(
        id = x$id %||% NA_character_,
        name = x$caption %||% NA_character_,
        programId = paste(pid, collapse = "; "),
        sourceUrl = paste(unlist(x$properties$sourceUrl %||% character()), collapse = "; ")
      )
    }
  }

  if (i %% 20000 == 0) message("Read ", i, " lines; kept ", k)
}

df_terror <- bind_rows(rows)
nrow(df_terror)
head(df_terror)

```
```{r}

```

```{r}




##hi hello this is reem confused
```

























