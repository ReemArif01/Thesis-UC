---
title: "test"
output: html_document
---

```{r}
install.packages("tidyverse")
install.packages("dplyr")
```

```{r}
library(tidyverse)
library(dplyr)
library(rvest)
library(tibble)
library(stringr)

install.packages(c("httr2", "jsonlite", "dplyr", "purrr", "stringr", "readr"))
library(httr2)
library(jsonlite)
library(dplyr)
library(purrr)
library(readr)

```

```{r}
#This where you find the list of UN decisions
##https://main.un.org/securitycouncil/en/sanctions/1267/press-releases?page=0

```

```{r}


`%||%` <- function(x, y) if (is.null(x)) y else x

folder <- "/Users/reemarif/Desktop/1st Quarter/MA Sources/Thesis-UC"
path <- file.path(folder, "entities.ftm (1).json")

con <- file(path, open = "r")
on.exit(close(con), add = TRUE)

rows <- list()
k <- 0
i <- 0

while (length(line <- readLines(con, n = 1, warn = FALSE)) > 0) {
  i <- i + 1
  x <- fromJSON(line, simplifyVector = FALSE)

  if (!identical(x$schema, "Organization")) next

  sanc <- x$properties$sanctions
  if (is.null(sanc)) next

  for (s in sanc) {
    authority <- tolower(paste(unlist(s$authority %||% character(), use.names = FALSE), collapse = " "))
    program   <- tolower(paste(unlist(s$program   %||% character(), use.names = FALSE), collapse = " "))

    is_eu_authority <- str_detect(authority, "financial stability|capital markets union|directorate|european union")
    is_terror_program <- str_detect(program, "terror|2580|931|specific measures to combat terrorism")

    if (is_eu_authority && is_terror_program) {
      start <- unlist(s$startDate %||% character(), use.names = FALSE)[1] %||% NA_character_
      end   <- unlist(s$endDate   %||% character(), use.names = FALSE)[1] %||% NA_character_

      k <- k + 1
      rows[[k]] <- tibble(
        id = x$id %||% NA_character_,
        name = x$caption %||% NA_character_,
        eu_start_date = start,
        eu_end_date = end,
        eu_program = paste(unlist(s$program %||% character(), use.names = FALSE), collapse = " Â· ")
      )
    }
  }

  if (i %% 50000 == 0) message("Read ", i, " entities; kept ", k, " EU-terror rows")
}

df_raw <- bind_rows(rows)

# One row per organization: earliest EU start date
df_small <- df_raw |>
  mutate(eu_start_date = na_if(eu_start_date, "")) |>
  group_by(id, name) |>
  summarise(
    eu_designation_date = suppressWarnings(min(eu_start_date, na.rm = TRUE)),
    eu_end_date = suppressWarnings(min(na_if(eu_end_date, ""), na.rm = TRUE)),
    eu_program = paste(unique(eu_program), collapse = " | "),
    .groups = "drop"
  ) |>
  mutate(
    eu_designation_date = ifelse(is.infinite(eu_designation_date), NA, eu_designation_date),
    eu_end_date = ifelse(is.infinite(eu_end_date), NA, eu_end_date)
  )

write.csv(df_small,
          file.path(folder, "eu_terrorism_designation_dates_small.csv"),
          row.names = FALSE)



```

```{r}

`%||%` <- function(x, y) if (is.null(x)) y else x

path <- "/Users/reemarif/Desktop/1st Quarter/MA Sources/Thesis-UC/entities.ftm (1).json"
con <- file(path, open = "r")

rows <- list()
i <- 0
k <- 0

while (length(line <- readLines(con, n = 1, warn = FALSE)) > 0) {
  i <- i + 1
  x <- fromJSON(line, simplifyVector = FALSE)

  if (identical(x$schema, "Organization")) {
    ds <- unlist(x$datasets %||% x$properties$datasets %||% character(), use.names = FALSE)

    if ("eu_fsf" %in% ds) {
      k <- k + 1
      rows[[k]] <- tibble(
        id = x$id %||% NA_character_,
        name = x$caption %||% NA_character_,
        datasets = paste(ds, collapse = "; ")
      )
    }
  }

  if (i %% 10000 == 0) message("Read ", i, " lines; kept ", k, " EU FSF orgs")
}

close(con)

df <- bind_rows(rows)
nrow(df)
head(df, 20)

write.csv(df, "/Users/reemarif/Desktop/eu_fsf_organizations.csv", row.names = FALSE)

```
```{r}
# pick one EU FSF org id
one_id <- df$id[1]

# re-read just that one entity from the big file (simple but works)
con <- file(path, open = "r")
found <- NULL
while (length(line <- readLines(con, n = 1, warn = FALSE)) > 0) {
  x <- fromJSON(line, simplifyVector = FALSE)
  if (!is.null(x$id) && identical(x$id, one_id)) { found <- x; break }
}
close(con)

names(found$properties)
str(found$properties, max.level = 2)

```
```{r}
`%||%` <- function(x, y) if (is.null(x)) y else x

path <- "/Users/reemarif/Desktop/1st Quarter/MA Sources/Thesis-UC/entities.ftm (1).json"

con <- file(path, open = "r")
on.exit(close(con), add = TRUE)

rows <- list()
i <- 0
k <- 0

while (length(line <- readLines(con, n = 1, warn = FALSE)) > 0) {
  i <- i + 1
  x <- fromJSON(line, simplifyVector = FALSE)

  if (identical(x$schema, "Organization")) {
    ds <- unlist(x$datasets %||% x$properties$datasets %||% character(), use.names = FALSE)

    pid <- unlist(x$properties$programId %||% character(), use.names = FALSE)

    # TEMP diagnostic: keep anything that mentions terrorism
    if (any(str_detect(tolower(pid), "terror|931"))) {
      k <- k + 1
      rows[[k]] <- tibble(
        id = x$id %||% NA_character_,
        name = x$caption %||% NA_character_,
        programId = paste(pid, collapse = "; "),
        sourceUrl = paste(unlist(x$properties$sourceUrl %||% character()), collapse = "; ")
      )
    }
  }

  if (i %% 20000 == 0) message("Read ", i, " lines; kept ", k)
}

df_terror <- bind_rows(rows)
nrow(df_terror)
head(df_terror)

```

```{r}

file.info("Gathering Data.Rmd")$size 


```







##this is a test, maybe???

now?
















